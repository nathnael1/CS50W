{% extends "network/layout.html" %}
{% load static %}
{% block body %}
    <h1>
        Profile
    </h1>
    <div class="profile">
       <p>Username {{username}}</p>
         <p>Bio {{bio}}</p>
            <p id = "followers">Followers {{followers}}</p>
            <p id = "following">Following {{following}}</p>
            <img src="{{image_link}}" alt="">
            <p id = "postNumber">Posts {{postNumber}}</p>
            {% if request.user.is_authenticated and request.user.username != username %}
            {% if followed %}

                
                <button id = "unfollow" data-user = {{username}}>Unfollow</button>

            {%else%}

                <button id = "follow" data-user = {{username}}>Follow</button>
            {%endif%}
            {% endif %}
    </div>
    
    {% for publish in publishes %}

        <div class="published">
            <a href="#" class = "postuser">{{publish.user}}</a>
            <p class = "content">{{publish.content}}</p>
            <p class = "time">{{publish.time}}</p>
            <p class ="likeNumber">Likes: {{publish.likes}}</p>
            {% if publish.liked_by_user and button %}
            <button data-postid="{{publish.id}}" class = "like">dislike</button>
            {% elif button %}
            <button data-postid = "{{publish.id}}" class="like">like</button>
            {% endif %}
            {% if request.user.username == publish.user.username %}
                <button class="edit" data-postid = "{{publish.id}}">Edit</button>
                <button class="delete" data-postid = "{{publish.id}}">Delete</button>
            {%endif%}
        </div>
        {%empty%}
        <h1>No posts</h1>
    {% endfor %}
        <script>
                    //delete post
        document.querySelectorAll('.delete').forEach(function(button) {
            button.addEventListener('click', function() {
                let post_id = button.dataset.postid;
                fetch('/delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        post_id: post_id,
                    })
                })
                .then(response => response.json())
                .then(result => {
                    console.log(result.message);
                    button.closest('.published').style.display = 'none';
                    document.getElementById('postNumber').innerHTML = `Posts: ${result.posts}`
                })
            })

        })
        //like and dislike
        document.querySelectorAll('.like').forEach(function(button) {
    let post_id = button.dataset.postid;
    button.addEventListener('click', function() {
        fetch('/like', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                post_id: post_id,
            })
        })
        .then(response => response.json())
        .then(result => {
            console.log(result.message);
            let like_element = this.closest('.published').querySelector('.likeNumber');
            like_element.innerHTML = `Likes: ${result.likes}`;
            
            // Update the button text based on the current state
            if (this.innerHTML.trim() === 'like') {
                this.innerHTML = 'dislike';
            } else {
                this.innerHTML = 'like';
            }
        })
        .catch(error => console.log('error', error));
    });
});
            
    //editing post
    document.querySelectorAll('.edit').forEach(function(button) {
        button.addEventListener('click', function() {
            let content = this.closest('.published').querySelector('.content').innerHTML;
            let post_id = button.dataset.postid
            
            console.log(post_id)
            this.closest('.published').querySelector('.content').style.display="none";
            this.closest('.published').querySelector('.time').style.display="none";
            this.closest('.published').querySelector('.like').style.display="none";
            this.closest('.published').querySelector('.edit').style.display="none";
            this.closest('.published').querySelector('.delete').style.display="none";
            
            text = document.createElement('textarea')
            save = document.createElement('button')
            save.innerHTML = 'Save'
            text.innerHTML = content
            this.closest('.published').append(text)
            this.closest('.published').append(save)
            save.addEventListener('click',()=>{
                content = text.value
   
                fetch('/edit',{
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                post_id: post_id,
                                content: content,
                                
                            })
                        })
                            .then(response => response.json())
                            .then(result => {
                                console.log(result.message)
                               text.style.display="none";
                                 save.style.display="none";

                                this.closest('.published').querySelector('.content').style.display="block";
                                this.closest('.published').querySelector('.time').style.display="block";
                                this.closest('.published').querySelector('.like').style.display="block";
                                this.closest('.published').querySelector('.edit').style.display="block";
                                this.closest('.published').querySelector('.delete').style.display="block";
                                this.closest('.published').querySelector('.content').innerHTML = content
                })
                            .catch(error => console.log('error', error))
                
            })
        });
    });
        </script>
    
{% endblock %}